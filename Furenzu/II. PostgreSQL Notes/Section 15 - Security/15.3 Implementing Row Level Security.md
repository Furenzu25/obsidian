## ğŸ›¡ï¸ Study Notes: Row-Level Security (RLS) in PostgreSQL

### ğŸ‘‹ Introduction

Hello students! Welcome to another class, and this time we're diving into a crucial topic in database management: **Security**â€”specifically, **Row-Level Security (RLS)**.

RLS is a powerful PostgreSQL feature that allows fine-grained control over **which rows a user can access in a table**, even if they have permission to access the table itself.

---

### ğŸ“Œ Why RLS Is Important

- By default, PostgreSQL allows users to access **all rows** in a table if they have SELECT permission.
    
- In scenarios like accounting systems or multi-tenant applications, **users should only see their own data**.
    
- RLS helps prevent unauthorized access to sensitive or competitive information.
    

---

### âš™ï¸ How RLS Works

RLS lets you define **policies** that restrict access to table rows based on **conditions**.

ğŸ”‘ **Superuser Requirement:**  
To enable RLS and create policies, you need superuser privileges.

---

### ğŸ§ª Step-by-Step Implementation

#### 1. **Create a user and table**
	
	sql
	
`CREATE ROLE joe LOGIN PASSWORD '123456'; CREATE TABLE person (gender TEXT, name TEXT);`

#### 2. **Insert sample data**
	
	sql
	
`INSERT INTO person VALUES ('male', 'Joe'), ('female', 'Sarah'), (NULL, 'R2-D2');`

#### 3. **Grant access**
	
	sql
	
`GRANT ALL ON person TO joe;`

#### 4. **Enable RLS**
	
	sql
	
`ALTER TABLE person ENABLE ROW LEVEL SECURITY;`

#### 5. **Try selecting as Joe**
	
	sql
	
`-- No rows returned because no policy is yet defined SELECT * FROM person;`

---

### âœ… Creating a Basic RLS Policy

Letâ€™s allow user `joe` to view only rows where `gender = 'male'`:
	
	sql
	
`CREATE POLICY joe_policy ON person FOR SELECT TO joe USING (gender = 'male');`

Now, when `joe` runs:
	
	sql
	
`SELECT * FROM person;`

âœ… He sees only male records.

---

### â• Adding More Policies with OR Logic

PostgreSQL (by default) combines multiple RLS policies with an **OR** condition.

Example: Also allow Joe to view rows where `gender IS NULL`:
	
	sql
	
`CREATE POLICY joe_null_policy ON person FOR SELECT TO joe USING (gender IS NULL);`

Now Joe can see both `male` and `null`-gender rows.

---

### ğŸ” Using `EXPLAIN` to See RLS Filtering
	
	sql
	
`EXPLAIN SELECT * FROM person;`

Will show filters applied:
	
	pgsql
	
`Filter: ((gender IS NULL) OR (gender = 'male'))`

---

### âœï¸ Policies for Data Modification

#### ğŸ›‘ Without insert policy:

Joe will **get an error** if he tries to insert data.

#### âœ… Allow insert:
	
	sql
	
`CREATE POLICY insert_policy ON person FOR INSERT TO joe WITH CHECK (gender = 'male' OR gender IS NULL);`

Now Joe can insert valid data under allowed conditions.

---

### âš ï¸ Behavior with RETURNING clause

If Joe tries:
	
	sql
	
`INSERT INTO person VALUES ('female', 'Anna') RETURNING *;`

âŒ It fails, because his policy does not permit SELECT on female rows.

âœ… But this works:
	
	sql
	
`INSERT INTO person VALUES ('male', 'Bob') RETURNING *;`

---

### ğŸ“š Summary

- ğŸ” **Row-Level Security (RLS)** adds per-row access control.
    
- ğŸ§‘â€ğŸ’» Policies define which users can see or modify which rows.
    
- â• Multiple policies combine with OR by default.
    
- âœ… `USING` applies filters for queries.
    
- ğŸ› ï¸ `WITH CHECK` applies filters for inserts/updates.
    
- ğŸ”„ Policy changes are dynamicâ€”no table reloads required.
    
- ğŸš« Even full access to a table does **not** bypass RLS restrictions.
    

---

### ğŸ¯ Key Takeaways

- Use RLS for **multi-tenant apps**, **HR systems**, **finance apps**, etc.
    
- Always test policies with realistic users.
    
- Combine **permissive** and **restrictive** logic based on your security needs.
    

---

### ğŸ Thatâ€™s a Wrap!

Thanks for sticking through this important topic! ğŸ™Œ  
More security techniques and tips are coming in the next class. If you have questions, ask them on the course forum.

**Hugs to everyone! ğŸ¤—**