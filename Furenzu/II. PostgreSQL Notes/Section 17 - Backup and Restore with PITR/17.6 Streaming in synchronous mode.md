## ğŸ§  **Study Notes: Synchronous Streaming Replication in PostgreSQL**

### ğŸ‘‹ Introduction

Welcome to another lesson in our PostgreSQL series!  
This class is a **continuation** of the previous one, focusing on how to **configure streaming replication** using a **synchronous method** alongside an asynchronous setup.

---

### ğŸ” Synchronous vs Asynchronous Replication

|Feature|Asynchronous|Synchronous|
|---|---|---|
|ğŸ”„ Delivery Time|Faster|Slower|
|ğŸ›¡ï¸ Data Integrity|Lower|Higher|
|ğŸ“¡ Confirmation|Not required from standby server|Requires confirmation from standby|
|ğŸ“Š Use Case|General backup|Critical operations, failover, load balancing|

- With **synchronous replication**, the **primary server waits** for confirmation from the **standby server** before completing a transaction.
    
- This adds latency but **ensures data integrity** â€” ideal for read-only operations and high-reliability environments.
    

---

### âš™ï¸ Server Setup Recap

#### âœ… Primary Server

- Already configured in the previous class.
    
- User and config file (e.g., `postgresql.conf`, `pg_hba.conf`) are set.
    

#### ğŸ–¥ï¸ Standby Servers

- Two standby machines are used:
    
    - **PG2** as a **synchronous** standby
        
    - **PG3** as an **asynchronous** standby
        

ğŸ’¡ **PostgreSQL allows mixing both replication methods simultaneously.**

---

### ğŸ› ï¸ Key Configurations

#### ğŸ“„ `postgresql.conf`

- Enable archiving and specify archive command:
		
		bash
		
    `archive_mode = on archive_command = 'rsync ...'`
    
- Define standby names:
		
		bash
		
    `synchronous_standby_names = 'replica1' synchronous_commit = 'remote_apply'  # safest and most recommended`
    

#### ğŸ“„ `pg_hba.conf`

- Add the host IP with proper method (md5 or trust).
    

---

### âœ… Synchronous Commit Methods

|Option|Description|
|---|---|
|**off**|Doesnâ€™t wait for any sync (âš ï¸ not recommended)|
|**local**|Only writes locally (âš ï¸ risky)|
|**remote_write**|Waits until data is written to standbyâ€™s memory|
|**remote_apply**|âœ… **Safest**: Waits until data is applied to replica|
|**on**|Equivalent to `remote_apply`|

---

### ğŸ§ª Replica Setup Process

1. **Install PostgreSQL** (if not already).
    
2. Download from the official repository.
    
3. Create a **faithful backup**:
    
    - Ensure **same extensions**, **tablespaces**, **encryption**, and **permissions**.
        
4. Run `pg_basebackup` to create a copy of the main database.
    
5. Adjust file permissions (e.g., `chmod 600`).
    
6. Link to the correct data directory.
    
7. Configure `postgresql.conf` and add:
		
		bash
		
    `primary_conninfo = '... application_name=replica1'`
    
8. Restart the server.
    

---

### ğŸ§ª Validation Steps

- Connect to the PostgreSQL shell.
    
- Run:
		
		sql
		
    `SELECT * FROM pg_stat_replication;`
    
- You should see:
    
    - Replica1 (synchronous)
        
    - Replica2 (asynchronous)
        
- Both should reflect correct **IP addresses**, **application names**, and **statuses**.
    

ğŸ§ª Try running a `CREATE TABLE` or `SELECT` on both replicas â€” results should be **identical**.

---

### ğŸ§© Extra Notes

- âœ… Ensure **extension compatibility** (e.g., PG Audit).
    
- âœ… Confirm **directory structure and WAL files** are in sync.
    
- â— If using certificate-based authentication, replicate certificates and permissions.
    
- ğŸ” All user settings, tablespaces, and configurations **must match** the primary.
    

---

### ğŸ‘‹ Wrap-up

And that's it! Youâ€™ve now learned how to:

âœ… Configure a **synchronous replication**  
âœ… Combine both **sync and async** methods  
âœ… Safely manage PostgreSQL **failover and data integrity**

If you still have questions, donâ€™t hesitate to post them on the course forum. ğŸ“

---

ğŸ“˜ **Key Commands to Remember**
	
	bash
	
`rsync -av ... pg_basebackup -h <host> -D <directory> -U <user> -Fp -Xs -P -R chmod 600 <file> SELECT * FROM pg_stat_replication;`

---

ğŸ§‘â€ğŸ’» Keep practicing, stay curious, andâ€¦  
See you in the next lesson! ğŸš€