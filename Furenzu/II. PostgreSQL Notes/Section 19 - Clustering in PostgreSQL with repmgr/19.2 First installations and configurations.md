# ğŸ› ï¸ PostgreSQL Replication Cluster â€“ Setup & Preparation Study Notes

## ğŸ¯ Objective:

Prepare and configure **four machines** (can be virtual or physical) for a **PostgreSQL replication cluster** using **`repmgr`**.  
Machines:

- `PG1` â Primary server
    
- `PG2`, `PG3` â Standby servers
    
- `PG Witness` â Arbitrator server (elects new primary on failure)
    

---

## ğŸ–§ Step 1: Configure Hostnames & IPs

- Use `hostname -I` to find each machineâ€™s IP address.
    
- Edit `/etc/hosts` on **all machines** to include:
		
		php-template
		
    `<IP>   PG1 <IP>   PG2 <IP>   PG3 <IP>   PGWitness`
    
- âœ… This allows hostname-based communication via `ping PGx`.
    

---

## ğŸ“¦ Step 2: Install `repmgr` Package

- Make sure **PostgreSQL is already installed** and functioning.
    
- Install `repmgr` **on all machines** using version-appropriate commands:
		
		bash
		
    `export PG_VERSION=15 # Install repmgr for your PG version`
    
- Versions supported: `14, 15, 16, 17+`.
    

---

## ğŸ‘¤ Step 3: Configure Postgres User for Replication

### ğŸ”’ Sudoers Configuration

- Grant the `postgres` user passwordless access to key commands:
    
    - Edit `/etc/sudoers` (e.g., via `visudo`)
        
    - Add under root section:
	        
	        sql
	        
        `postgres ALL=(ALL) NOPASSWD: ALL`
        

### ğŸ” `pg_hba.conf` â€“ Access Permissions

- Edit `pg_hba.conf` in PostgreSQL data directory:
    
    - Add access for the `repmgr` user using `trust` method (no password):
	        
	        php-template
	        
        `host    repmgr     repmgr     <LAN-IP>/24    trust`
        
- ğŸ” Do this on **all machines**.
    

---

## ğŸ› ï¸ Step 4: Create Replication User & Database

- Run as root or postgres user:
	    
	    bash
	    
    `createuser --superuser repmgr createdb --owner=repmgr repmgr`
    
- Then:
		
		bash
		
    `alter user repmgr set search_path TO repmgr, "$user", public;`
    
- ğŸ”„ Repeat on PG1, PG2, PG3, and Witness.
    

---

## ğŸ” Step 5: Restart PostgreSQL Servers
	
	bash
	
`sudo systemctl restart postgresql`

- Do this on all machines to apply configuration changes.
    

---

## ğŸ§ª Step 6: Test Peer-to-Peer Connections

- On each machine, test connecting to others using:
		
		bash
		
    `psql -h <hostname> -U repmgr -d repmgr`
    
- âœ… Connection should be **direct**, **without password**, and successful for:
    
    - PG1 â†” PG2 â†” PG3 â†” PG Witness
        

---

## ğŸ§© Step 7: Configure Postgres Environment (Optional but Helpful)

- For easier command-line access to binaries, add the following to `~/.profile` or `~/.bashrc` of the `postgres` user:
		
		bash
		
    `export PATH=$PATH:/usr/pgsql-15/bin`
    
- Reload profile:
		
		bash
		
    `source ~/.profile`
    
- Test `repmgr` binary access:
		
		bash
		
    `repmgr --help`
    

---

## ğŸ§¼ Summary of Completed Steps

âœ… IP & Hostnames configured  
âœ… `repmgr` installed on all machines  
âœ… `postgres` user has sudo privileges  
âœ… PostgreSQL access configured via `pg_hba.conf`  
âœ… Replication user `repmgr` and database created  
âœ… All nodes tested for direct connectivity  
âœ… Optional PATH configured for easier `repmgr` access

---

## â­ï¸ Next Up:

In the following class, weâ€™ll begin **creating the cluster** by configuring the **primary server (PG1)**.  
ğŸ’¬ If you have any issues, drop a question in the course forum.

ğŸ“ _All commands and files are available in the course materials for reference._