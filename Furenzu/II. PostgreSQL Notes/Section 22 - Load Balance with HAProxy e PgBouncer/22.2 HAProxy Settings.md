# ğŸ§  Study Notes: PG Bouncer Setup & Configuration ğŸš€

---

## ğŸ¯ **Purpose of PG Bouncer**

PG Bouncer is a lightweight PostgreSQL connection pooler, created around **2007**. Its main function is to **optimize database queries** by efficiently managing connections.

ğŸ”¹ Acts like a **proxy**  
ğŸ”¹ Reduces overhead by **reusing database connections**  
ğŸ”¹ Handles connections **in order of arrival**  
ğŸ”¹ Greatly reduces performance issues caused by excess simultaneous connections

---

## ğŸ› ï¸ **Installation Steps**

### âœ… **1. Install on `pg1` (and later all pool servers):**

bash

CopyEdit

`sudo apt install pgbouncer`

### âœ… **2. Set Permissions:**

- Give **`postgres` user** full access to PG Bouncer's directory.
    

### âœ… **3. Create Users:**

- Create a test/monitoring user:  
    `user: check`  
    `password: (same as postgres)`
    
- Create a main Bouncer user:  
    `user: bouncer`
    

---

## âš™ï¸ **Service Configuration**

### âœ… **4. Enable and Reload PG Bouncer:**
	
	bash
	
`sudo systemctl enable pgbouncer sudo systemctl restart pgbouncer`

---

## ğŸ§¾ **User Auth Setup**

### âœ… **5. Generate and Configure `userlist.txt`:**

- Collect all user credentials (hashed in MD5)
    
- Save to `/tmp/userlist.txt`
    
	bash
	
`cp /tmp/userlist.txt /etc/pgbouncer/`

ğŸ‘€ Check contents:  
Youâ€™ll see users like `pgmonitor`, `check`, etc., with their MD5 hashed passwords.

---

## ğŸ› ï¸ **Main PG Bouncer Config File**

- **Allow all databases:** Use `*` to allow connections to all DBs
    
- **Allow all IPs:** Set to listen on all addresses
    
- **Set admin user:** `admin_users = postgres`
    
- **Max clients:** Set (e.g., 1000)
    
- **Connection pool settings:**
    
    - `pool_size = 25` per user/database
        
    - Adjust based on **performance needs**
        

âš ï¸ If connections get too high â†’ performance suffers  
âœ… Reserve smaller pools for critical apps

---

## ğŸ” **Authentication Methods**

- Use `trust` or `md5` depending on use case
    
- Make sure the **userlist file and config names** match for consistency
    

---

## â™»ï¸ **Restart PG Bouncer**
	
	bash
	
`sudo systemctl restart pgbouncer`

---

## ğŸ“š **Extra Config Insights**

- PG Bouncer has **many tunable options** in its config file
    
- Important:  
    `max_client_conn = 100` (default)  
    Increase this if needed, but monitor performance.
    
- It is **not** a load balancer.  
    Think of it as a **proxy** that enhances connection handling.
    

---

## ğŸ§ª **Connect & Test**

### Connect as `postgres`:
	
	bash
	
`sudo su - postgres psql -h localhost -p 6432 -U postgres`

> Default PG port is `5432`, but PG Bouncer listens on `6432`

ğŸ¯ Result: A working proxy connection to your DB!

---

## ğŸ§© **Monitor Connections**

Inside PG Bouncer admin console:

ğŸ”¹ Show overall status:
	
	sql
	
`SHOW STATS;`

ğŸ”¹ Show connected servers:
	
	sql
	
`SHOW SERVERS;`

ğŸ”¹ Show client sessions:
	
	sql
	
`SHOW CLIENTS;`

ğŸ”¹ Show database/user pools:
	
	sql
	
`SHOW POOLS;`

---

## ğŸ”„ **Update HAProxy Port**

- Change proxy port to `6432` to reflect the PG Bouncer setup.
    
- Restart HAProxy:
	
	bash
	
`sudo systemctl restart haproxy`

âœ… Check logs and ensure **no errors**  
ğŸ’¡ If you see â€œworkersâ€ with no errors, it's running fine!

---

## âœ… **Final Checks**

- Verify all remote connections via `psql`
    
- Ensure all servers in the pool (e.g., `pg2`, `pg3`, etc.) have PG Bouncer installed
    
- Confirm the proxy now works with PG Bouncer as its backend
    

---

## ğŸ’¬ **Wrap-Up**

ğŸ‰ PG Bouncer was successfully configured to act as a proxy for PostgreSQL, with pooling, monitoring, and HAProxy integration. This setup greatly improves performance and connection management.

ğŸ§© For further tweaking: check PG Bouncerâ€™s [FAQ] and config file documentation  
ğŸ™‹â€â™‚ï¸ Questions? Visit the course forum

---

ğŸ‘‹ _Hugs to everyone!_  
Happy optimizing! ğŸ’»ğŸ“ˆ